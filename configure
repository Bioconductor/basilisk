#!/bin/bash

${R_HOME}/bin/R --slave --no-save -e '
inst_dir <- tail(commandArgs(), 1)

# Stripped from https://github.com/hafen/rminiconda
# To be replaced if rminiconda gets into CRAN.
arch <- paste0("x86", ifelse(.Machine$sizeof.pointer == 8, "_64", ""))
version <- "4.7.10"
sysname <- if (Sys.info()[["sysname"]] == "Darwin") {
    "MacOSX"
} else {
    "Linux"
}

inst_file <- sprintf("Miniconda3-%s-%s-%s.sh", version, sysname, arch)
base_url <- "https://repo.anaconda.com/miniconda/"
tmploc <- file.path(tempdir(), inst_file)
dest_path <- file.path(inst_dir, "inst", "miniconda")

if (TRUE) {
    # FOR INTERNAL TESTING ONLY, avoid re-downloading and 
    # re-installing miniconda everytime we update the R package.
    dest_path2 <- file.path(path.expand("~/"), ".miniconda")
    if (!file.exists(dest_path2)) {
        download.file(paste0(base_url, inst_file), tmploc)
        inst_args <- sprintf(" %s -b -p %s", tmploc, dest_path2)
        system2("bash", inst_args)
    }

    dir.create(dirname(dest_path), recursive=TRUE)
    file.symlink(dest_path2, dest_path)
} else {
    download.file(paste0(base_url, inst_file), tmploc)
    inst_args <- sprintf(" %s -b -p %s", tmploc, dest_path)
    system2("bash", inst_args)
}

# Installing "core" packages on top.
system2(file.path(dest_path, "bin", "python3"), c("-m", "pip", "install", readLines(file.path("inst", "core_list"))))
' --args "${R_PACKAGE_DIR}"
